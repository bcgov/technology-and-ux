import { r as resolveComponent, o as openBlock, c as createElementBlock, a as createBaseVNode, b as createVNode, F as Fragment, e as createStaticVNode, d as createTextVNode } from "./app.fb818619.js";
import { _ as _export_sfc } from "./plugin-vue_export-helper.21dcd24c.js";
var _imports_0 = "/cloud-pathfinder/assets/policy.a5ae5fca.png";
var _imports_1 = "/cloud-pathfinder/assets/oidc-picture-2.713b0c86.png";
var _imports_2 = "/cloud-pathfinder/assets/oidc-picture-3.78132e7b.png";
const _sfc_main = {};
const _hoisted_1 = /* @__PURE__ */ createStaticVNode('<h1 id="_2-configuring-aws-to-use-oidc" tabindex="-1"><a class="header-anchor" href="#_2-configuring-aws-to-use-oidc" aria-hidden="true">#</a> 2. Configuring AWS to use OIDC</h1><ul><li><p>The AWS environment created for the ministry teams already includes the OIDC components, however, it is necessary to create roles and policies that, using OIDC authentication, will allow trusted third parties (GitHub in this tutorial) to use AWS resources. This trust relationship between GitHub and the AWS account needs to be created for each AWS account that GitHub will use to deploy resources</p></li><li><p>The process starts crafting policies. These policies will later be assigned to the role that will be used by the trusted third party (GitHub in this How To). These policies should provide only enough permissions for the third party to do its job, otherwise you may be introducing a security risk. Please check section 4 for suggestions on how to create policies</p></li></ul><h2 id="_2-1-crafting-policies" tabindex="-1"><a class="header-anchor" href="#_2-1-crafting-policies" aria-hidden="true">#</a> 2.1 Crafting policies</h2><ul><li><p>Policies grant specific rights to specific resources.You will need to create policies tailored to the needs ofthe application you are deploying in AWS.</p></li><li><p>To create custom policies:</p><ul><li><p>a. Log into AWS console</p><p>b. Open IAM &gt; Policies</p><p>c. Click on Create policy button</p><p>d. The Wizard will help you to create the policy. Choose a meaningful name for the policy.</p></li></ul></li><li><p>If later you need to change the policy, you can always open it and edit it.</p></li><li><p>For example, the code that deploys the application may need to create a S3 bucket, so the policy will Allow the <code>&quot;s3:CreateBucket&quot;</code> action. In this context, the code may check if the bucket exists before creating it by listing the existing buckets. So, the code requires to be allowed to execute the <code>&quot;s3:ListBucket&quot;</code> action. If the code also requires to delete the bucket after using it, then it the policy needs to allow the <code>&quot;s3:DeleteBuckets&quot;</code> action</p><p>So, the resulting policy will be:</p></li></ul><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>\n    <span class="token property">&quot;Version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2012-10-17&quot;</span><span class="token punctuation">,</span>\n    <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n        <span class="token punctuation">{</span>\n            <span class="token property">&quot;Sid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;S3&quot;</span><span class="token punctuation">,</span>\n            <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span>\n            <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n                <span class="token string">&quot;s3:CreateBucket&quot;</span><span class="token punctuation">,</span>\n                <span class="token string">&quot;s3:ListBucket&quot;</span><span class="token punctuation">,</span>\n                <span class="token string">&quot;s3:DeleteBucket&quot;</span>\n            <span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">]</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ul><li><p>In the above example these actions allow deletion of any bucket from the code invoked by GitHub Actions.As written above, this policy includes all buckets in the account. For example,it would include buckets created by the budgets service that has nothing to do with your current application. Overall, the code should have the minimum necessary permissions.</p></li><li><p>We can restrict the resources to which the policy allows the deletion of buckets. In this case, if we know the app creates a bucket with name <code>upload-bucket*</code> a better suited policy can be created, like</p></li></ul><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>\n    <span class="token property">&quot;Version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2012-10-17&quot;</span><span class="token punctuation">,</span>\n    <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n        <span class="token punctuation">{</span>\n            <span class="token property">&quot;Sid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;S3&quot;</span><span class="token punctuation">,</span>\n            <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span>\n            <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n                <span class="token string">&quot;s3:CreateBucket&quot;</span><span class="token punctuation">,</span>\n                <span class="token string">&quot;s3:ListBucket&quot;</span><span class="token punctuation">,</span>\n                <span class="token string">&quot;s3:DeleteBucket&quot;</span>\n            <span class="token punctuation">]</span><span class="token punctuation">,</span>\n            <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n                <span class="token string">&quot;arn:aws:s3:::upload-bucket*&quot;</span>\n            <span class="token punctuation">]</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ul><li><p>Policies are customized to the app you are deploying in AWS. You will need to craft different policies for different apps.</p></li><li><p>Please keep in mind that best practices recommend these policies should only grant the minimum set of permissions necessary for the app to be deployed. See section 4 for suggestions.</p></li></ul><h2 id="_2-2-creating-a-roles" tabindex="-1"><a class="header-anchor" href="#_2-2-creating-a-roles" aria-hidden="true">#</a> 2.2 Creating a Roles</h2><ul><li><p>Policies are attached to roles. The actions granted by the policies are bestowed on the entities for which the role has a trust relationship</p></li><li><p>The steps to create a role are:</p><p>a. Log to the AWS console using your AWS account credentials (for an example see section 5).</p><p>b. In the search tab, type IAM, once found, open the IAM dashboard</p><p>c. On the left side, click on Roles</p><p>d. Click on the Create Rolebutton</p><p>e. Select Web Identityas trusted entity type</p><p>f. Select token.actions.githubusercontent.comas identity providerfrom the drop down</p><p>g. As Audience enter <code>repo:&lt;repo address&gt;:ref:refs/heads/&lt;branch&gt;</code> then click Next</p><p>h. Select the policies you want to add to this roleand click Next(the policies created in section 2.1will be listed here)</p><ul><li><p>In the following screenshot the policies <code>Registry_Deployment_IAM_Policy_for_Con-tainers_App_Part1</code> and <code>Registry_Deployment_IAM_Policy_for_Containers_App_Part2</code> have been added to the list of policies for the role</p><p><img src="' + _imports_0 + '" alt="Policy"></p><p>i. Give the role a name (in this example we will use the name testOIDCrole), write a description of it, review the information.</p><ul><li>Note: In the above page you will find the Select trusted entities section with an Edit button that sug-gests that is possible to edit the trusted entities from this page. When going through this procedure, the Edit button simply returned to the previous step in the role creation procedure. In this context, the instructions in this How to suggest proceeding and later edit the trusted entities (step k)</li></ul><p>j. Go to the end of the page and click on the Create Role button.</p><p>k. Once created, search and open the role . You can add, remove permissions, and edit the trusted entities by opening the Trust relationships tab and clicking on the Edit trust policy <img src="' + _imports_1 + '" alt="Trust Relationships"></p><p>tweak it to be like below</p></li></ul></li></ul><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>\n    <span class="token property">&quot;Version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2012-10-17&quot;</span><span class="token punctuation">,</span>\n    <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n        <span class="token punctuation">{</span>\n            <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span>\n            <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sts:AssumeRoleWithWebIdentity&quot;</span><span class="token punctuation">,</span>\n            <span class="token property">&quot;Principal&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n                <span class="token property">&quot;Federated&quot;</span><span class="token operator">:</span> <span class="token string">&quot;arn:aws:iam::512345678905:oidc-provider/token.actions.githubusercontent.com&quot;</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token property">&quot;Condition&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n                <span class="token property">&quot;StringLike&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n                    <span class="token property">&quot;token.actions.githubusercontent.com:sub&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n                        <span class="token string">&quot;repo:myreporoot/myreponame:*&quot;</span>\n                    <span class="token punctuation">]</span>\n                <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token property">&quot;ForAllValues:StringEquals&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n                    <span class="token property">&quot;token.actions.githubusercontent.com:aud&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sts.amazonaws.com&quot;</span><span class="token punctuation">,</span>\n                    <span class="token property">&quot;token.actions.githubusercontent.com:iss&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://token.actions.githubusercontent.com&quot;</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">]</span>\n<span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><ul><li><p>The number in the Federated key is the AWS account number that you are using. The value for the Condition key corresponds to the repo and branch (see point g) used by GitHub actions to deploy the app</p><ul><li>Note: The step creates a trust relationship between AWS and GitHub and grants the permissions allowed in the policies to run the code in the repository indicated in Condition to GitHub actions. Code included in other repositories will require to be added as another Condition</li><li>The example covers all branches in the repository</li></ul></li></ul><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;StringLike&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n                    <span class="token property">&quot;token.actions.githubusercontent.com:sub&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n                        <span class="token string">&quot;repo:myreporoot/myreponame:*&quot;</span>\n                    <span class="token punctuation">]</span>\n                <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>So all branches in the repo can assume the role and deploy the app.</li></ul><p>l. Once the Trust relationships have been edited, click the Update policy button to save the edits</p><p>m. Find and save the arn for the newly created role. In the previous example, from the above screenshot</p><p><img src="' + _imports_2 + '" alt="arn"></p><p>would be: arn:aws:iam::512345678906:role/testOIDCrole</p><ul><li><p>The arn value will be used later when configuring GitHub to use OIDC</p><ul><li>Note: Notice the role ties together the polices (listed in the Permissions tab) with the trust relationship. In the example above, GitHub can only assume the role that will allow to deploy the app when it connects to AWS through a web call and from a specific repo</li></ul></li></ul><h2 id="note" tabindex="-1"><a class="header-anchor" href="#note" aria-hidden="true">#</a> Note</h2>', 20);
const _hoisted_21 = /* @__PURE__ */ createBaseVNode("li", null, [
  /* @__PURE__ */ createBaseVNode("p", null, "When using GitHub OIDC to deploy the applications to AWS via Infrastructure as a code(example Terraform), you need an S3 Bucket and DynamoDB table created. The S3 Bucket is to store the state files and the DynamoDB table is used to store the lock files.")
], -1);
const _hoisted_22 = /* @__PURE__ */ createTextVNode("More on using s3 backend with terraform can be found ");
const _hoisted_23 = {
  href: "https://developer.hashicorp.com/terraform/language/settings/backends/s3",
  target: "_blank",
  rel: "noopener noreferrer"
};
const _hoisted_24 = /* @__PURE__ */ createTextVNode("here");
const _hoisted_25 = /* @__PURE__ */ createBaseVNode("p", null, "You can use AWS CLI to create the s3 bucket and DynamoDB table.", -1);
const _hoisted_26 = /* @__PURE__ */ createBaseVNode("li", null, [
  /* @__PURE__ */ createBaseVNode("p", null, "you need AWS CLI already installed to manage and interact with various services provided by the AWS.")
], -1);
const _hoisted_27 = /* @__PURE__ */ createTextVNode("Please refer to the documentation ");
const _hoisted_28 = {
  href: "https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html",
  target: "_blank",
  rel: "noopener noreferrer"
};
const _hoisted_29 = /* @__PURE__ */ createTextVNode("here");
const _hoisted_30 = /* @__PURE__ */ createTextVNode(" to install the AWS CLI for your operating system. We also recommend using package managers like ");
const _hoisted_31 = {
  href: "https://brew.sh/",
  target: "_blank",
  rel: "noopener noreferrer"
};
const _hoisted_32 = /* @__PURE__ */ createTextVNode("Homebrew");
const _hoisted_33 = /* @__PURE__ */ createTextVNode(" for mac or ");
const _hoisted_34 = {
  href: "https://chocolatey.org/",
  target: "_blank",
  rel: "noopener noreferrer"
};
const _hoisted_35 = /* @__PURE__ */ createTextVNode("Chocolatey");
const _hoisted_36 = /* @__PURE__ */ createTextVNode(" for windows to download and manage all the tools and softwares, which makes it easy to install, uninstall or upggrade the softwares.");
const _hoisted_37 = /* @__PURE__ */ createStaticVNode('<ul><li><p>After the AWS CLI is installed, you can use the following commands to create S3 and DynamoDB tables.</p></li><li><p>To create an s3 bucket with the name <code>terraform-remote-state-167465127160</code> you can use the following command</p></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>    aws s3api create-bucket --bucket terraform-remote-state-167465127160 --region ca-central-1 --create-bucket-configuration <span class="token assign-left variable">LocationConstraint</span><span class="token operator">=</span>ca-central-1\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ul><li>To enable bucket versioning on the created s3 bucket <code>terraform-remote-state-167465127160</code> you can use the following command</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>    aws s3api put-bucket-versioning --bucket terraform-remote-state-167465127160 --versioning-configuration <span class="token assign-left variable">Status</span><span class="token operator">=</span>Enabled\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><code>Note that the S3 bucket names should be globally unique. So please change the bucket name highlighted to a unique name. In the above bucket example we used the bucket name followed by a AWS AccountID which is unique to each AWS account.</code></p><ul><li>To create a DynamoDB table with the name <code>Terraform-backend-lock-167465127160</code> to store the lock files you can use the following command</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>aws dynamodb create-table --table-name Terraform-backend-lock-167465127160 --attribute-definitions <span class="token assign-left variable">AttributeName</span><span class="token operator">=</span>LockID,AttributeType<span class="token operator">=</span>S --key-schema <span class="token assign-left variable">AttributeName</span><span class="token operator">=</span>LockID,KeyType<span class="token operator">=</span>HASH --provisioned-throughput <span class="token assign-left variable">ReadCapacityUnits</span><span class="token operator">=</span><span class="token number">5</span>,WriteCapacityUnits<span class="token operator">=</span><span class="token number">5</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div>', 7);
function _sfc_render(_ctx, _cache) {
  const _component_ExternalLinkIcon = resolveComponent("ExternalLinkIcon");
  return openBlock(), createElementBlock(Fragment, null, [
    _hoisted_1,
    createBaseVNode("ul", null, [
      _hoisted_21,
      createBaseVNode("li", null, [
        createBaseVNode("p", null, [
          _hoisted_22,
          createBaseVNode("a", _hoisted_23, [
            _hoisted_24,
            createVNode(_component_ExternalLinkIcon)
          ])
        ])
      ]),
      createBaseVNode("li", null, [
        _hoisted_25,
        createBaseVNode("ul", null, [
          _hoisted_26,
          createBaseVNode("li", null, [
            createBaseVNode("p", null, [
              _hoisted_27,
              createBaseVNode("a", _hoisted_28, [
                _hoisted_29,
                createVNode(_component_ExternalLinkIcon)
              ]),
              _hoisted_30,
              createBaseVNode("a", _hoisted_31, [
                _hoisted_32,
                createVNode(_component_ExternalLinkIcon)
              ]),
              _hoisted_33,
              createBaseVNode("a", _hoisted_34, [
                _hoisted_35,
                createVNode(_component_ExternalLinkIcon)
              ]),
              _hoisted_36
            ]),
            _hoisted_37
          ])
        ])
      ])
    ])
  ], 64);
}
var _02_Configuring_AWS_to_use_OIDC_html = /* @__PURE__ */ _export_sfc(_sfc_main, [["render", _sfc_render]]);
export { _02_Configuring_AWS_to_use_OIDC_html as default };
