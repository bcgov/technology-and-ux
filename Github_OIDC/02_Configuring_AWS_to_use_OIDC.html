<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.33">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" type="image/png" sizes="16x16" href="/vuepress/src/.vuepress/public/ns/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/icons/favicon-32x32.png"><link rel="manifest" href="/manifest.webmanifest"><meta name="application-name" content="VuePress"><meta name="apple-mobile-web-app-title" content="VuePress"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png"><link rel="mask-icon" href="/images/icons/safari-pinned-tab.svg" color="#3eaf7c"><meta name="msapplication-TileColor" content="#3eaf7c"><meta name="theme-color" content="#3eaf7c"><title>2. Configuring AWS to use OIDC | </title><meta name="description" content="CPF Documentation">
    <link rel="modulepreload" href="/cloud-pathfinder/assets/app.fb818619.js"><link rel="modulepreload" href="/cloud-pathfinder/assets/02_Configuring_AWS_to_use_OIDC.html.75132807.js"><link rel="modulepreload" href="/cloud-pathfinder/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/cloud-pathfinder/assets/02_Configuring_AWS_to_use_OIDC.html.345388eb.js">
    <link rel="stylesheet" href="/cloud-pathfinder/assets/style.e044799a.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/cloud-pathfinder/" class=""><img class="logo" src="/cloud-pathfinder/cloud_pathfinder_icon_2022.png" alt><!----></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/cloud-pathfinder/guide/" class="" aria-label="Guide"><!--[--><!--]--> Guide <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Documentation"><span class="title">Documentation</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Documentation"><span class="title">Documentation</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Pre-Reading Material</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/cloud-pathfinder/Documentation/Pre-reading-material/" class="" aria-label="Pre-Reading Material"><!--[--><!--]--> Pre-Reading Material <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/cloud-pathfinder/Github_OIDC/" class="router-link-active" aria-label="GitHub OIDC"><!--[--><!--]--> GitHub OIDC <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Material"><span class="title">Material</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Material"><span class="title">Material</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>PDF&#39;s</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a class="external-link" href="https://github.com/bcgov/cloud-pathfinder/raw/master/docs/assets/Pre-reading-material.pdf" rel="noopener noreferrer" target="_blank" aria-label="Pre-reading-material"><!--[--><!--]--> Pre-reading-material <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/bcgov/cloud-pathfinder" rel="noopener noreferrer" target="_blank" aria-label="CloudPathfinder"><!--[--><!--]--> CloudPathfinder <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/cloud-pathfinder/guide/" class="" aria-label="Guide"><!--[--><!--]--> Guide <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Documentation"><span class="title">Documentation</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Documentation"><span class="title">Documentation</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Pre-Reading Material</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/cloud-pathfinder/Documentation/Pre-reading-material/" class="" aria-label="Pre-Reading Material"><!--[--><!--]--> Pre-Reading Material <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/cloud-pathfinder/Github_OIDC/" class="router-link-active" aria-label="GitHub OIDC"><!--[--><!--]--> GitHub OIDC <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Material"><span class="title">Material</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Material"><span class="title">Material</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>PDF&#39;s</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a class="external-link" href="https://github.com/bcgov/cloud-pathfinder/raw/master/docs/assets/Pre-reading-material.pdf" rel="noopener noreferrer" target="_blank" aria-label="Pre-reading-material"><!--[--><!--]--> Pre-reading-material <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/bcgov/cloud-pathfinder" rel="noopener noreferrer" target="_blank" aria-label="CloudPathfinder"><!--[--><!--]--> CloudPathfinder <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p class="sidebar-item sidebar-heading active">Github-OIDC <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/cloud-pathfinder/Github_OIDC/01_Intraduction.html" class="sidebar-item" aria-label="1. Introduction"><!--[--><!--]--> 1. Introduction <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/cloud-pathfinder/Github_OIDC/02_Configuring_AWS_to_use_OIDC.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="2. Configuring AWS to use OIDC"><!--[--><!--]--> 2. Configuring AWS to use OIDC <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/cloud-pathfinder/Github_OIDC/02_Configuring_AWS_to_use_OIDC.html#_2-1-crafting-policies" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.1 Crafting policies"><!--[--><!--]--> 2.1 Crafting policies <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/cloud-pathfinder/Github_OIDC/02_Configuring_AWS_to_use_OIDC.html#_2-2-creating-a-roles" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2 Creating a Roles"><!--[--><!--]--> 2.2 Creating a Roles <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/cloud-pathfinder/Github_OIDC/02_Configuring_AWS_to_use_OIDC.html#note" class="router-link-active router-link-exact-active sidebar-item" aria-label="Note"><!--[--><!--]--> Note <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/cloud-pathfinder/Github_OIDC/03_Configuring_OIDC_in_GitHub.html" class="sidebar-item" aria-label="3. Configuring OIDC in GitHub"><!--[--><!--]--> 3. Configuring OIDC in GitHub <!--[--><!--]--></a><!----></li><li><a href="/cloud-pathfinder/Github_OIDC/04_Refining_the_policies.html" class="sidebar-item" aria-label="4. Refining the policies"><!--[--><!--]--> 4. Refining the policies <!--[--><!--]--></a><!----></li><li><a href="/cloud-pathfinder/Github_OIDC/05_readmore.html" class="sidebar-item" aria-label="Read more"><!--[--><!--]--> Read more <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="_2-configuring-aws-to-use-oidc" tabindex="-1"><a class="header-anchor" href="#_2-configuring-aws-to-use-oidc" aria-hidden="true">#</a> 2. Configuring AWS to use OIDC</h1><ul><li><p>The AWS environment created for the ministry teams already includes the OIDC components, however, it is necessary to create roles and policies that, using OIDC authentication, will allow trusted third parties (GitHub in this tutorial) to use AWS resources. This trust relationship between GitHub and the AWS account needs to be created for each AWS account that GitHub will use to deploy resources</p></li><li><p>The process starts crafting policies. These policies will later be assigned to the role that will be used by the trusted third party (GitHub in this How To). These policies should provide only enough permissions for the third party to do its job, otherwise you may be introducing a security risk. Please check section 4 for suggestions on how to create policies</p></li></ul><h2 id="_2-1-crafting-policies" tabindex="-1"><a class="header-anchor" href="#_2-1-crafting-policies" aria-hidden="true">#</a> 2.1 Crafting policies</h2><ul><li><p>Policies grant specific rights to specific resources.You will need to create policies tailored to the needs ofthe application you are deploying in AWS.</p></li><li><p>To create custom policies:</p><ul><li><p>a. Log into AWS console</p><p>b. Open IAM &gt; Policies</p><p>c. Click on Create policy button</p><p>d. The Wizard will help you to create the policy. Choose a meaningful name for the policy.</p></li></ul></li><li><p>If later you need to change the policy, you can always open it and edit it.</p></li><li><p>For example, the code that deploys the application may need to create a S3 bucket, so the policy will Allow the <code>&quot;s3:CreateBucket&quot;</code> action. In this context, the code may check if the bucket exists before creating it by listing the existing buckets. So, the code requires to be allowed to execute the <code>&quot;s3:ListBucket&quot;</code> action. If the code also requires to delete the bucket after using it, then it the policy needs to allow the <code>&quot;s3:DeleteBuckets&quot;</code> action</p><p>So, the resulting policy will be:</p></li></ul><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;Version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2012-10-17&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;Sid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;S3&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">&quot;s3:CreateBucket&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;s3:ListBucket&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;s3:DeleteBucket&quot;</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ul><li><p>In the above example these actions allow deletion of any bucket from the code invoked by GitHub Actions.As written above, this policy includes all buckets in the account. For example,it would include buckets created by the budgets service that has nothing to do with your current application. Overall, the code should have the minimum necessary permissions.</p></li><li><p>We can restrict the resources to which the policy allows the deletion of buckets. In this case, if we know the app creates a bucket with name <code>upload-bucket*</code> a better suited policy can be created, like</p></li></ul><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;Version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2012-10-17&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;Sid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;S3&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">&quot;s3:CreateBucket&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;s3:ListBucket&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;s3:DeleteBucket&quot;</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">&quot;arn:aws:s3:::upload-bucket*&quot;</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ul><li><p>Policies are customized to the app you are deploying in AWS. You will need to craft different policies for different apps.</p></li><li><p>Please keep in mind that best practices recommend these policies should only grant the minimum set of permissions necessary for the app to be deployed. See section 4 for suggestions.</p></li></ul><h2 id="_2-2-creating-a-roles" tabindex="-1"><a class="header-anchor" href="#_2-2-creating-a-roles" aria-hidden="true">#</a> 2.2 Creating a Roles</h2><ul><li><p>Policies are attached to roles. The actions granted by the policies are bestowed on the entities for which the role has a trust relationship</p></li><li><p>The steps to create a role are:</p><p>a. Log to the AWS console using your AWS account credentials (for an example see section 5).</p><p>b. In the search tab, type IAM, once found, open the IAM dashboard</p><p>c. On the left side, click on Roles</p><p>d. Click on the Create Rolebutton</p><p>e. Select Web Identityas trusted entity type</p><p>f. Select token.actions.githubusercontent.comas identity providerfrom the drop down</p><p>g. As Audience enter <code>repo:&lt;repo address&gt;:ref:refs/heads/&lt;branch&gt;</code> then click Next</p><p>h. Select the policies you want to add to this roleand click Next(the policies created in section 2.1will be listed here)</p><ul><li><p>In the following screenshot the policies <code>Registry_Deployment_IAM_Policy_for_Con-tainers_App_Part1</code> and <code>Registry_Deployment_IAM_Policy_for_Containers_App_Part2</code> have been added to the list of policies for the role</p><p><img src="/cloud-pathfinder/assets/policy.a5ae5fca.png" alt="Policy"></p><p>i. Give the role a name (in this example we will use the name testOIDCrole), write a description of it, review the information.</p><ul><li>Note: In the above page you will find the Select trusted entities section with an Edit button that sug-gests that is possible to edit the trusted entities from this page. When going through this procedure, the Edit button simply returned to the previous step in the role creation procedure. In this context, the instructions in this How to suggest proceeding and later edit the trusted entities (step k)</li></ul><p>j. Go to the end of the page and click on the Create Role button.</p><p>k. Once created, search and open the role . You can add, remove permissions, and edit the trusted entities by opening the Trust relationships tab and clicking on the Edit trust policy <img src="/cloud-pathfinder/assets/oidc-picture-2.713b0c86.png" alt="Trust Relationships"></p><p>tweak it to be like below</p></li></ul></li></ul><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;Version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2012-10-17&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sts:AssumeRoleWithWebIdentity&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Principal&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;Federated&quot;</span><span class="token operator">:</span> <span class="token string">&quot;arn:aws:iam::512345678905:oidc-provider/token.actions.githubusercontent.com&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Condition&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;StringLike&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;token.actions.githubusercontent.com:sub&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                        <span class="token string">&quot;repo:myreporoot/myreponame:*&quot;</span>
                    <span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;ForAllValues:StringEquals&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;token.actions.githubusercontent.com:aud&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sts.amazonaws.com&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;token.actions.githubusercontent.com:iss&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://token.actions.githubusercontent.com&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><ul><li><p>The number in the Federated key is the AWS account number that you are using. The value for the Condition key corresponds to the repo and branch (see point g) used by GitHub actions to deploy the app</p><ul><li>Note: The step creates a trust relationship between AWS and GitHub and grants the permissions allowed in the policies to run the code in the repository indicated in Condition to GitHub actions. Code included in other repositories will require to be added as another Condition</li><li>The example covers all branches in the repository</li></ul></li></ul><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;StringLike&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;token.actions.githubusercontent.com:sub&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                        <span class="token string">&quot;repo:myreporoot/myreponame:*&quot;</span>
                    <span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>So all branches in the repo can assume the role and deploy the app.</li></ul><p>l. Once the Trust relationships have been edited, click the Update policy button to save the edits</p><p>m. Find and save the arn for the newly created role. In the previous example, from the above screenshot</p><p><img src="/cloud-pathfinder/assets/oidc-picture-3.78132e7b.png" alt="arn"></p><p>would be: arn:aws:iam::512345678906:role/testOIDCrole</p><ul><li><p>The arn value will be used later when configuring GitHub to use OIDC</p><ul><li>Note: Notice the role ties together the polices (listed in the Permissions tab) with the trust relationship. In the example above, GitHub can only assume the role that will allow to deploy the app when it connects to AWS through a web call and from a specific repo</li></ul></li></ul><h2 id="note" tabindex="-1"><a class="header-anchor" href="#note" aria-hidden="true">#</a> Note</h2><ul><li><p>When using GitHub OIDC to deploy the applications to AWS via Infrastructure as a code(example Terraform), you need an S3 Bucket and DynamoDB table created. The S3 Bucket is to store the state files and the DynamoDB table is used to store the lock files.</p></li><li><p>More on using s3 backend with terraform can be found <a href="https://developer.hashicorp.com/terraform/language/settings/backends/s3" target="_blank" rel="noopener noreferrer">here<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p></li><li><p>You can use AWS CLI to create the s3 bucket and DynamoDB table.</p><ul><li><p>you need AWS CLI already installed to manage and interact with various services provided by the AWS.</p></li><li><p>Please refer to the documentation <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html" target="_blank" rel="noopener noreferrer">here<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> to install the AWS CLI for your operating system. We also recommend using package managers like <a href="https://brew.sh/" target="_blank" rel="noopener noreferrer">Homebrew<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> for mac or <a href="https://chocolatey.org/" target="_blank" rel="noopener noreferrer">Chocolatey<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> for windows to download and manage all the tools and softwares, which makes it easy to install, uninstall or upggrade the softwares.</p><ul><li><p>After the AWS CLI is installed, you can use the following commands to create S3 and DynamoDB tables.</p></li><li><p>To create an s3 bucket with the name <code>terraform-remote-state-167465127160</code> you can use the following command</p></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>    aws s3api create-bucket --bucket terraform-remote-state-167465127160 --region ca-central-1 --create-bucket-configuration <span class="token assign-left variable">LocationConstraint</span><span class="token operator">=</span>ca-central-1
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ul><li>To enable bucket versioning on the created s3 bucket <code>terraform-remote-state-167465127160</code> you can use the following command</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>    aws s3api put-bucket-versioning --bucket terraform-remote-state-167465127160 --versioning-configuration <span class="token assign-left variable">Status</span><span class="token operator">=</span>Enabled
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><code>Note that the S3 bucket names should be globally unique. So please change the bucket name highlighted to a unique name. In the above bucket example we used the bucket name followed by a AWS AccountID which is unique to each AWS account.</code></p><ul><li>To create a DynamoDB table with the name <code>Terraform-backend-lock-167465127160</code> to store the lock files you can use the following command</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>aws dynamodb create-table --table-name Terraform-backend-lock-167465127160 --attribute-definitions <span class="token assign-left variable">AttributeName</span><span class="token operator">=</span>LockID,AttributeType<span class="token operator">=</span>S --key-schema <span class="token assign-left variable">AttributeName</span><span class="token operator">=</span>LockID,KeyType<span class="token operator">=</span>HASH --provisioned-throughput <span class="token assign-left variable">ReadCapacityUnits</span><span class="token operator">=</span><span class="token number">5</span>,WriteCapacityUnits<span class="token operator">=</span><span class="token number">5</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></li></ul></li></ul><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/bcgov/cloud-pathfinder/edit/master/vuepress/src/Github_OIDC/02_Configuring_AWS_to_use_OIDC.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page on GitHub"><!--[--><!--]--> Edit this page on GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: Luke.Gonis@gov.bc.ca">Luke Gonis</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/cloud-pathfinder/Github_OIDC/01_Intraduction.html" class="" aria-label="1. Introduction"><!--[--><!--]--> 1. Introduction <!--[--><!--]--></a></span><span class="next"><a href="/cloud-pathfinder/Github_OIDC/03_Configuring_OIDC_in_GitHub.html" class="" aria-label="3. Configuring OIDC in GitHub"><!--[--><!--]--> 3. Configuring OIDC in GitHub <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/cloud-pathfinder/assets/app.fb818619.js" defer></script>
  </body>
</html>
